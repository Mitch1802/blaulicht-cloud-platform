name: 02 Build & Push Docker Images

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
    paths:
      - 'frontend/**'
      - 'docker/**'
      - 'install/**'
      - 'default.conf'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  workflow_run:
    workflows: ["01 Generate Django Migrations"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: build-push
  cancel-in-progress: true

jobs:
  build_push:
    name: Build & Push
    runs-on: ubuntu-24.04 
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Check out (push / manual)
        if: github.event_name != 'workflow_run'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check out (workflow_run head_sha)
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Init build flag
        run: echo "BUILT=true" >> "$GITHUB_ENV"

      - name: Load DOCKER_REPO (GitHub variable)
        shell: bash
        run: |
          set -euo pipefail
          echo "DOCKER_REPO=${{ vars.DOCKER_REPO }}" >> "$GITHUB_ENV"
      
      - name: Load PUBLIC_FAHRZEUG_PIN (GitHub variable)
        shell: bash
        run: |
          set -euo pipefail
          echo "PUBLIC_FAHRZEUG_PIN=${{ secrets.PUBLIC_FAHRZEUG_PIN }}" >> "$GITHUB_ENV"

      - name: Determine CHANNEL + VERSION
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"   # v1.2.3
            VERSION="${TAG#v}"              # 1.2.3
            CHANNEL="prod"
          else
            VERSION="test"
            CHANNEL="test"
          fi

          SHORT_SHA="${GITHUB_SHA::7}"

          echo "CHANNEL=$CHANNEL" >> "$GITHUB_ENV"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"

      - name: Verify required vars
        shell: bash
        run: |
          set -euo pipefail
          echo "EVENT=${{ github.event_name }}"
          echo "BUILT=$BUILT"
          echo "CHANNEL=$CHANNEL"
          echo "VERSION=$VERSION"
          echo "SHORT_SHA=$SHORT_SHA"
          echo "DOCKER_REPO=$DOCKER_REPO"
          echo "PUBLIC_FAHRZEUG_PIN=$PUBLIC_FAHRZEUG_PIN"
          test -n "$DOCKER_REPO"

      - name: Set up Node
        if: env.BUILT == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify lockfile exists
        if: env.BUILT == 'true'
        shell: bash
        run: |
          set -euo pipefail
          test -f frontend/package-lock.json || (echo "frontend/package-lock.json missing" && exit 1)
      
      - name: Generate frontend version.json
        if: env.BUILT == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p frontend/src/assets
          cat <<EOF > frontend/src/assets/version.json
          {
            "version": "${VERSION}",
            "commit": "${SHORT_SHA}",
            "channel": "${CHANNEL}",
            "builtAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          echo "version.json created:"
          cat frontend/src/assets/version.json

      - name: Install & Build Angular (CI)
        if: env.BUILT == 'true'
        run: |
          cd frontend
          npm ci --no-audit --no-fund
          npm run build

      - name: Set up Docker Buildx
        if: env.BUILT == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.BUILT == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build images (compose)
        if: env.BUILT == 'true'
        env:
          DOCKER_REPO: ${{ env.DOCKER_REPO }}
          VERSION: ${{ env.VERSION }}
        run: |
          docker compose -f docker-compose.yml build

      - name: Push images (compose)
        if: env.BUILT == 'true'
        env:
          DOCKER_REPO: ${{ env.DOCKER_REPO }}
          VERSION: ${{ env.VERSION }}
        run: |
          docker compose -f docker-compose.yml push

      - name: Add + push snapshot tags (test only)
        if: env.BUILT == 'true' && env.CHANNEL == 'test'
        shell: bash
        env:
          DOCKER_REPO: ${{ env.DOCKER_REPO }}
          SHORT_SHA: ${{ env.SHORT_SHA }}
        run: |
          set -euo pipefail

          docker tag "mitch122/${DOCKER_REPO}:api-test"   "mitch122/${DOCKER_REPO}:api-test-${SHORT_SHA}"
          docker tag "mitch122/${DOCKER_REPO}:db-test"    "mitch122/${DOCKER_REPO}:db-test-${SHORT_SHA}"
          docker tag "mitch122/${DOCKER_REPO}:nginx-test" "mitch122/${DOCKER_REPO}:nginx-test-${SHORT_SHA}"

          docker push "mitch122/${DOCKER_REPO}:api-test-${SHORT_SHA}"
          docker push "mitch122/${DOCKER_REPO}:db-test-${SHORT_SHA}"
          docker push "mitch122/${DOCKER_REPO}:nginx-test-${SHORT_SHA}"

      - name: Create build metadata artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build-meta
          printf "BUILT=%s\nCHANNEL=%s\nVERSION=%s\nDOCKER_REPO=%s\nSHORT_SHA=%s\n" \
            "${BUILT:-true}" "${CHANNEL:-test}" "${VERSION:-test}" "${DOCKER_REPO:-}" "${SHORT_SHA:-}" \
            > build-meta/meta.env
          cat build-meta/meta.env

      - name: Upload build metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-meta
          path: build-meta/meta.env
          if-no-files-found: error
