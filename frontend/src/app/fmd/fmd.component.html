<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="fmd-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>Atemschutz Verwaltung</h2>
    </div>

    <mat-card-content>
        @if (hasTable(activeTabIndex)) {
        <mat-form-field
          class="mb-2"
          style="max-width: 320px"
        >
          <mat-label>Filter</mat-label>
          <input
            matInput
            #filterInput
            (input)="applyFilter(filterInput.value)"
            placeholder="Suchen..."
          />
        </mat-form-field>
        }

        <mat-tab-group (selectedIndexChange)="onTabChange($event)">
          <mat-tab label="Übersicht">
            <section class="app-grid mt-3 mb-3 mx-0">
              <div class="app-col-12 app-col-lg-4">
                <h2>Tauglichkeit</h2>
                @if (chartTauglichkeit.datasets[0].data.length) {
                <canvas
                  baseChart
                  [data]="chartTauglichkeit"
                  [type]="pieChartType"
                  [options]="pieChartOptions"
                >
                </canvas>
                }
              </div>
              <div class="app-col-12 app-col-lg-4">
                <h2>Untersuchung</h2>
                @if (chartUntersuchung.datasets[0].data.length) {
                <canvas
                  baseChart
                  [data]="chartUntersuchung"
                  [type]="pieChartType"
                  [options]="pieChartOptions"
                >
                </canvas>
                }
              </div>
              <div class="app-col-12 app-col-lg-4">
                <h2>Altersverteilung</h2>
                @if (chartAlter.datasets[0].data.length) {
                <canvas
                  baseChart
                  [data]="chartAlter"
                  [type]="pieChartType"
                  [options]="pieChartOptions"
                >
                </canvas>
                }
              </div>
            </section>
          </mat-tab>
          <mat-tab label="ATS Träger">
            <button
              mat-flat-button
              color="accent"
              class="me-2 mb-3"
              [hidden]="!formModul.disabled"
              (click)="neueDetails()"
              type="button"
            >
              Hinzufügen
            </button>
            <form
              [formGroup]="formModul"
              (ngSubmit)="datenSpeichern()"
              [hidden]="formModul.disabled"
            >
              <input
                hidden
                type="text"
                class="form-control"
                formControlName="id"
              />
              <button
                mat-flat-button
                color="accent"
                class="me-3 mt-3 mb-3"
                [hidden]="!formModul.valid"
                type="submit"
              >
                Daten speichern
              </button>
              <button
                mat-flat-button
                class="mt-3 mb-3"
                color="primary"
                [hidden]="formModul.disabled"
                type="button"
                (click)="abbrechen()"
              >
                Abbrechen
              </button>
              <section class="app-grid mt-2 mx-0">
                <div class="app-col-12 app-col-lg-8 mb-3">
                  <mat-form-field>
                    <mat-label>Mitglied auswählen</mat-label>
                    <mat-select formControlName="mitglied_id">
                      @for (opt of dropdownMitglieder; track opt) {
                      <mat-option [value]="opt.pkid">
                        {{ opt.stbnr }} - {{ opt.vorname }}
                        {{ opt.nachname }}</mat-option
                      >
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>FDISK Update</mat-label>
                    <input
                      matInput
                      type="text"
                      formControlName="fdisk_aenderung"
                      placeholder="TT.MM.YYYY"
                    />
                    @if
                    (formModul.controls['fdisk_aenderung'].hasError('pattern'))
                    {
                    <mat-error
                      >Ungültiges Format. Bitte TT.MM.YYYY eingeben.</mat-error
                    >
                    } @if
                    (formModul.controls['fdisk_aenderung'].hasError('dateInvalid'))
                    {
                    <mat-error>Kein existierendes Datum!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>Arzttyp auswählen</mat-label>
                    <mat-select formControlName="arzt_typ">
                      @for (opt of arzttypen; track opt) {
                      <mat-option [value]="opt"> {{ opt }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-8 mb-3">
                  <mat-form-field>
                    <mat-label>Behandelnder Arzt</mat-label>
                    <input matInput type="text" formControlName="arzt" />
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>Letzte Untersuchung</mat-label>
                    <input
                      matInput
                      type="text"
                      formControlName="letzte_untersuchung"
                      placeholder="TT.MM.YYYY"
                    />
                    @if
                    (formModul.controls['letzte_untersuchung'].hasError('pattern'))
                    {
                    <mat-error
                      >Ungültiges Format. Bitte TT.MM.YYYY eingeben.</mat-error
                    >
                    } @if
                    (formModul.controls['letzte_untersuchung'].hasError('dateInvalid'))
                    {
                    <mat-error>Kein existierendes Datum!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>Leistungstest</mat-label>
                    <input
                      matInput
                      type="text"
                      formControlName="leistungstest"
                    />
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>Leistungstest Art</mat-label>
                    <mat-select formControlName="leistungstest_art">
                      @for (opt of leistungstestarten; track opt) {
                      <mat-option [value]="opt"> {{ opt }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-12 mb-3">
                  <mat-form-field>
                    <mat-label>Notizen</mat-label>
                    <input matInput type="text" formControlName="notizen" />
                  </mat-form-field>
                </div>
              </section>

              <button
                mat-flat-button
                color="warn"
                [hidden]="!formModul.controls['id'].value"
                type="button"
                (click)="datenLoeschen()"
              >
                Daten löschen
              </button>
            </form>
            <table
              mat-table
              [dataSource]="dataSource"
              [hidden]="!formModul.disabled"
              matSort
            >
              <ng-container matColumnDef="stbnr">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Stbnr.
                </th>
                <td mat-cell *matCellDef="let element">{{ element.stbnr }}</td>
              </ng-container>
              <ng-container matColumnDef="vorname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Vorname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.vorname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="nachname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Nachname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.nachname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Aktionen</th>
                <td mat-cell *matCellDef="let element">
                  <button
                    mat-flat-button
                    class="ms-2"
                    color="primary"
                    (click)="auswahlBearbeiten(element)"
                  >
                    <mat-icon class="m-0">edit</mat-icon>
                  </button>
                  <button
                    mat-flat-button
                    class="ms-2"
                    color="primary"
                    (click)="printChecklist(element)"
                  >
                    <mat-icon class="m-0">checklist</mat-icon>
                  </button>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="sichtbareSpaltenATS"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: sichtbareSpaltenATS"
              ></tr>
            </table>
          </mat-tab>
          <mat-tab label="Untersuchungen">
            <table
              mat-table
              [dataSource]="dataSource"
              class="mat-elevation-z8"
              matSort
            >
              <ng-container matColumnDef="stbnr">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Stbnr.
                </th>
                <td mat-cell *matCellDef="let element">{{ element.stbnr }}</td>
              </ng-container>
              <ng-container matColumnDef="vorname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Vorname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.vorname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="nachname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Nachname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.nachname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="letzte_untersuchung">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Letzte Untersuchung
                </th>
                <td
                  mat-cell
                  *matCellDef="let element"
                  [class.red-cell]="element.letzte_untersuchung === null"
                >
                  {{ element.letzte_untersuchung }}
                </td>
              </ng-container>
              <ng-container matColumnDef="naechste_untersuchung">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Nächste Untersuchung
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.naechste_untersuchung }}
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="sichtbareSpaltenUntersuchung"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: sichtbareSpaltenUntersuchung"
                [class.red-cell]="
                  +row.naechste_untersuchung <= currentYear ||
                  row.naechste_untersuchung === null
                "
              ></tr>
            </table>
          </mat-tab>
          <mat-tab label="Leistungstest">
            <table
              mat-table
              [dataSource]="dataSource"
              class="mat-elevation-z8"
              matSort
            >
              <ng-container matColumnDef="stbnr">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Stbnr.
                </th>
                <td mat-cell *matCellDef="let element">{{ element.stbnr }}</td>
              </ng-container>
              <ng-container matColumnDef="vorname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Vorname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.vorname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="nachname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Nachname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.nachname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="leistungstest">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Leistungstest
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.leistungstest }}
                </td>
              </ng-container>
              <ng-container matColumnDef="leistungstest_art">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Leistungstest Art
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.leistungstest_art }}
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="sichtbareSpaltenLeistungstest"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: sichtbareSpaltenLeistungstest"
                [class.red-cell]="!isLeistungstestOk(row.leistungstest)"
                [class.green-cell]="isLeistungstestOk(row.leistungstest)"
              ></tr>
            </table>
          </mat-tab>
          <mat-tab label="Tauglichkeit">
            <table
              mat-table
              [dataSource]="dataSource"
              class="mat-elevation-z8"
              matSort
            >
              <ng-container matColumnDef="stbnr">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Stbnr.
                </th>
                <td mat-cell *matCellDef="let element">{{ element.stbnr }}</td>
              </ng-container>
              <ng-container matColumnDef="vorname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Vorname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.vorname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="nachname">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Nachname
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.nachname }}
                </td>
              </ng-container>
              <ng-container matColumnDef="tauglichkeit">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Tauglichkeit
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.tauglichkeit }}
                </td>
              </ng-container>
              <tr
                mat-header-row
                *matHeaderRowDef="sichtbareSpaltenTauglichkeit"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: sichtbareSpaltenTauglichkeit"
                [class.red-cell]="row.tauglichkeit === 'nein'"
                [class.green-cell]="row.tauglichkeit === 'tauglich'"
              ></tr>
            </table>
          </mat-tab>
          <mat-tab label="Export">
            <div class="app-container ps-3 py-5" style="width: 90%">
              <div class="app-grid m-0 align-items-center">
                <div class="app-col-7">Offene Untersuchungen:</div>
                <div class="app-col-auto">
                  <button
                    mat-flat-button
                    color="primary"
                    (click)="printOffeneUntersuchugen()"
                  >
                    <mat-icon class="m-0">picture_as_pdf</mat-icon>
                  </button>
                </div>
              </div>
              <div class="app-grid m-0 pt-2 align-items-center">
                <div class="app-col-7">Tauglichkeit:</div>
                <div class="app-col-auto">
                  <button
                    mat-flat-button
                    color="primary"
                    (click)="printTauglichkeit()"
                  >
                    <mat-icon class="m-0">picture_as_pdf</mat-icon>
                  </button>
                </div>
              </div>
              <div class="app-grid m-0 pt-2 align-items-center">
                <div class="app-col-7">Leistungstest:</div>
                <div class="app-col-auto">
                  <button
                    mat-flat-button
                    color="primary"
                    (click)="printLeistungstest()"
                  >
                    <mat-icon class="m-0">picture_as_pdf</mat-icon>
                  </button>
                </div>
              </div>
              <div class="app-grid m-0 pt-2 align-items-center">
                <div class="app-col-7">Alle Mitglieder:</div>
                <div class="app-col-auto">
                  <button
                    mat-flat-button
                    color="primary"
                    (click)="printAlleMitglieder()"
                  >
                    <mat-icon class="m-0">picture_as_pdf</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>

        @if (hasTable(activeTabIndex)) {
        <mat-paginator
          [pageSizeOptions]="pageOptions"
          showFirstLastButtons
          aria-label="Auswahl Anzahl der sichtbaren Elemente"
        >
        </mat-paginator>
        }
    </mat-card-content>
  </mat-card>
</section>
