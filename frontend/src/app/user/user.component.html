<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="user-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>Benutzer verwalten</h2>
    </div>

    <mat-card-content>
      <form [formGroup]="formAuswahl" (ngSubmit)="auswahlBearbeiten()" [hidden]="!formModul.disabled">
        <section class="app-grid selector-row">
          <div class="app-col-12 app-col-lg-9">
            <mat-form-field class="full-width">
              <mat-label>Benutzer auswählen</mat-label>
              <mat-select formControlName="benutzer">
                @for (opt of benutzer; track opt) {
                  <mat-option [value]="opt.id"> {{ opt.username }} </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
          <div class="app-col-12 app-col-lg-3 selector-action">
            <button
              type="submit"
              mat-flat-button
              color="primary"
              [disabled]="!formAuswahl.controls['benutzer'].value"
            >
              Auswahl bearbeiten
            </button>
          </div>
        </section>
      </form>

      <div class="top-actions" [hidden]="!formModul.disabled">
        <button mat-flat-button color="accent" (click)="neueDetails()" type="button">
          Hinzufügen
        </button>
      </div>

      <form [formGroup]="formModul" (ngSubmit)="datenSpeichern()" [hidden]="formModul.disabled" class="edit-form">
        <input hidden type="text" class="form-control" formControlName="id" />

        <div class="form-actions">
          <button mat-flat-button color="accent" [hidden]="!formModul.valid" type="submit">
            Daten speichern
          </button>
          <button mat-flat-button color="primary" [hidden]="formModul.disabled" type="button" (click)="abbrechen()">
            Abbrechen
          </button>
        </div>

        @if (username === "admin") {
          <input hidden type="text" formControlName="username" />
        } @else {
          <section class="app-grid form-grid">
            <div class="app-col-12 app-col-lg-6 mb-3">
              <mat-form-field hintLabel="* Pflichtfeld" class="full-width">
                <mat-label>Benutzername</mat-label>
                <input matInput type="text" formControlName="username" />
                @if (formModul.controls['username'].hasError('required')) {
                  <mat-error> Benutzername ist erforderlich! </mat-error>
                }
              </mat-form-field>
            </div>
          </section>
        }

        <section class="app-grid form-grid">
          <div class="app-col-12 app-col-lg-6 mb-3">
            <mat-form-field hintLabel="* Pflichtfeld" class="full-width">
              <mat-label>Vorname</mat-label>
              <input matInput type="text" formControlName="first_name" />
              @if (formModul.controls['first_name'].hasError('required')) {
                <mat-error> Vorname ist erforderlich! </mat-error>
              }
            </mat-form-field>
          </div>
          <div class="app-col-12 app-col-lg-6 mb-3">
            <mat-form-field hintLabel="* Pflichtfeld" class="full-width">
              <mat-label>Nachname</mat-label>
              <input matInput type="text" formControlName="last_name" />
              @if (formModul.controls['last_name'].hasError('required')) {
                <mat-error> Nachname ist erforderlich! </mat-error>
              }
            </mat-form-field>
          </div>
        </section>

        <section class="app-grid role-row">
          @for (rolle of rollen; track rolle) {
            @if (rolle.key !== 'MITGLIED') {
              <div class="app-col-auto mb-3">
                <mat-checkbox
                  [checked]="formModul.controls['roles'].value?.includes(rolle.key)"
                  (change)="rolleToggle(rolle.key, $event)"
                >
                  {{ rolle.verbose_name }}
                </mat-checkbox>
              </div>
            }
          }
        </section>

        @if (formModul.controls['id'].value) {
          <hr />
          <section class="password-note">
            <p>Das Benutzer Passwort nur durch "Passwort ändern" geändert werden!</p>
          </section>
        }

        <section class="app-grid form-grid">
          <div class="app-col-12 app-col-lg-4 mb-3">
            <mat-form-field class="full-width">
              <mat-label>Passwort</mat-label>
              <input matInput type="password" formControlName="password1" />
            </mat-form-field>
            @if (formModul.controls['password1'].hasError('minlength')) {
              <mat-error>Das Passwort muss mindestens 8 Zeichen lang sein!</mat-error>
            }
          </div>
          <div class="app-col-12 app-col-lg-4 mb-3">
            <mat-form-field class="full-width">
              <mat-label>Passwort wiederholen</mat-label>
              <input matInput type="password" formControlName="password2" />
            </mat-form-field>
            @if (formModul.controls['password2'].hasError('minlength')) {
              <mat-error>Das Passwort muss mindestens 8 Zeichen lang sein!</mat-error>
            }
          </div>
          <div class="app-col-12 app-col-lg-4 password-action">
            <button
              mat-flat-button
              color="accent"
              [hidden]="!formModul.controls['id'].value"
              type="button"
              (click)="passwortAendern()"
            >
              Passwort ändern
            </button>
          </div>
        </section>

        @if (username !== "admin") {
          @if (formModul.controls['id'].value) {
            <hr />
          }
          <button
            mat-flat-button
            color="warn"
            [hidden]="!formModul.controls['id'].value"
            type="button"
            (click)="datenLoeschen()"
          >
            Daten löschen
          </button>
        }
      </form>
    </mat-card-content>
  </mat-card>
</section>
