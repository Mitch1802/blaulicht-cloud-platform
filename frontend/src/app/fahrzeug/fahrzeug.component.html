<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="fahrzeug-page">
  <header class="page-head">
    <h1>Fahrzeuge Verwaltung</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>Fahrzeuge & Beladung</h2>
    </div>

    <mat-card-content>
        <div class="toolbar mb-3">
          <button mat-flat-button color="accent" type="button" (click)="newFahrzeug()">
            <mat-icon>add</mat-icon>
            Neues Fahrzeug
          </button>
        </div>

        <section class="app-grid g-3">
          <div class="app-col-12 app-col-lg-5">
            <mat-card class="section-card">
              <mat-card-header>
                <mat-card-title>Fahrzeugliste</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="table-wrap">
                  <table mat-table [dataSource]="dataSource" matSort class="w-100">
                    <ng-container matColumnDef="name">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
                      <td mat-cell *matCellDef="let row">{{ row.name }}</td>
                    </ng-container>

                    <ng-container matColumnDef="bezeichnung">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Bezeichnung</th>
                      <td mat-cell *matCellDef="let row">{{ row.bezeichnung }}</td>
                    </ng-container>

                    <ng-container matColumnDef="public_id">
                      <th mat-header-cell *matHeaderCellDef>Public ID</th>
                      <td mat-cell *matCellDef="let row">{{ row.public_id }}</td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef>Aktionen</th>
                      <td mat-cell *matCellDef="let row">
                        <button mat-icon-button color="warn" type="button" (click)="$event.stopPropagation(); deleteFahrzeug(row)">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="sichtbareSpalten"></tr>
                    <tr
                      mat-row
                      *matRowDef="let row; columns: sichtbareSpalten"
                      (click)="selectRow(row)"
                      class="click-row"
                      [class.selected-row]="selectedId === row.id"
                    ></tr>
                  </table>
                </div>

                <mat-paginator [pageSize]="10"></mat-paginator>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="app-col-12 app-col-lg-7">
            <mat-card class="section-card">
              <mat-card-header>
                <mat-card-title>Fahrzeug bearbeiten</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <form [formGroup]="fahrzeugForm" class="form-grid mb-3">
                  <mat-form-field>
                    <mat-label>Name</mat-label>
                    <input matInput formControlName="name" />
                  </mat-form-field>

                  <mat-form-field>
                    <mat-label>Bezeichnung</mat-label>
                    <input matInput formControlName="bezeichnung" />
                  </mat-form-field>

                  <mat-form-field class="full-width">
                    <mat-label>Beschreibung</mat-label>
                    <textarea matInput rows="3" formControlName="beschreibung"></textarea>
                  </mat-form-field>

                  <div class="actions-row full-width">
                    <button mat-flat-button color="accent" type="button" (click)="saveFahrzeug()">
                      <mat-icon>save</mat-icon>
                      Speichern
                    </button>

                    <button mat-stroked-button type="button" (click)="newFahrzeug()">
                      Zurücksetzen
                    </button>

                    @if (selectedId) {
                      <a mat-stroked-button color="primary" [routerLink]="['/fahrzeuge', selectedId, 'check']">
                        <mat-icon>checklist</mat-icon>
                        Check öffnen
                      </a>
                    }
                  </div>
                </form>

                <mat-divider class="mb-3"></mat-divider>

                @if (selected; as f) {
                  <h3 class="section-title">Räume & Items: {{ f.name }}</h3>

                  <form [formGroup]="raumForm" class="raum-form mb-3">
                    <mat-form-field>
                      <mat-label>Raumname</mat-label>
                      <input matInput formControlName="name" />
                    </mat-form-field>

                    <mat-form-field>
                      <mat-label>Reihenfolge</mat-label>
                      <input matInput type="number" formControlName="reihenfolge" />
                    </mat-form-field>

                    <button mat-flat-button color="accent" type="button" (click)="addRaum()">
                      <mat-icon>add</mat-icon>
                      Raum
                    </button>
                  </form>

                  <mat-accordion>
                    @for (raum of f.raeume; track raum.id) {
                      <mat-expansion-panel>
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            {{ raum.name }} ({{ raum.items.length }} Items)
                          </mat-panel-title>
                          <mat-panel-description>
                            <button mat-icon-button color="warn" type="button" (click)="onDeleteRaum($event, raum)">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </mat-panel-description>
                        </mat-expansion-panel-header>

                        @for (item of raum.items; track item.id) {
                          <div class="item-row">
                            <div class="item-text">
                              <strong>{{ item.name }}</strong>
                              <span>— Soll: {{ item.menge }} {{ item.einheit }}</span>
                              @if (item.notiz) {
                                <span>• {{ item.notiz }}</span>
                              }
                            </div>

                            <button mat-icon-button color="warn" type="button" (click)="deleteItem(raum, item)">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        }

                        <form [formGroup]="itemFormFor(raum.id)" class="item-form mt-2">
                          <mat-form-field>
                            <mat-label>Item Name</mat-label>
                            <input matInput formControlName="name" />
                          </mat-form-field>

                          <mat-form-field>
                            <mat-label>Menge</mat-label>
                            <input matInput type="number" formControlName="menge" />
                          </mat-form-field>

                          <mat-form-field>
                            <mat-label>Einheit</mat-label>
                            <input matInput formControlName="einheit" />
                          </mat-form-field>

                          <mat-form-field>
                            <mat-label>Notiz</mat-label>
                            <input matInput formControlName="notiz" />
                          </mat-form-field>

                          <mat-form-field>
                            <mat-label>Reihenfolge</mat-label>
                            <input matInput type="number" formControlName="reihenfolge" />
                          </mat-form-field>

                          <button mat-flat-button color="accent" type="button" (click)="addItem(raum)">
                            <mat-icon>add</mat-icon>
                            Item
                          </button>
                        </form>
                      </mat-expansion-panel>
                    }
                  </mat-accordion>
                } @else {
                  <div class="empty-hint">
                    Wähle links ein Fahrzeug aus, um Räume & Items zu verwalten.
                  </div>
                }
              </mat-card-content>
            </mat-card>
          </div>
        </section>
    </mat-card-content>
  </mat-card>
</section>
