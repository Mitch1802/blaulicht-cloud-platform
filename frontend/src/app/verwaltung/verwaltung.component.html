<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="verwaltung-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>Rechnungen & Vorlagen</h2>
    </div>

    <mat-card-content>
      <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" class="invoice-tabs">
          <mat-tab label="Rechnung">
            <h3>SevDesk</h3>
            <form
              [formGroup]="formAuswahl"
              (ngSubmit)="sevdeskKontaktUebernehmen()"
            >
              <section class="app-grid m-0 mt-3">
                <div class="app-col-12 app-col-lg-9">
                  <mat-form-field>
                    <mat-label>SevDesk Kontakt auswählen</mat-label>
                    <mat-select formControlName="name">
                      @for (opt of kontakte; track opt) {
                        <mat-option [value]="opt.id">
                          {{ opt.name }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="app-col-6 app-col-lg-3">
                  <button
                    mat-flat-button
                    color="primary"
                    class="m-3"
                    type="submit"
                  >
                    übernehmen
                  </button>
                </div>
              </section>
            </form>
            <hr />
            <form [formGroup]="formRechnung" (ngSubmit)="printRechnung()">
              <button
                mat-flat-button
                color="primary"
                class="m-3"
                (click)="formRechnungReset()"
                type="button"
              >
                Reset
              </button>
              <button
                mat-flat-button
                color="accent"
                class="m-3"
                type="submit"
              >
                Drucken
              </button>
              <hr />
              <h3>Rechnungsdaten</h3>
              <section class="app-grid mt-2 mx-0">
                <div class="app-col-12 app-col-lg-12 mb-3">
                  <mat-form-field>
                    <mat-label>Name</mat-label>
                    <input matInput type="text" formControlName="adress_name" />
                    @if (
                      formRechnung.controls.adress_name.hasError("required")
                    ) {
                      <mat-error>Name ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-6 mb-3">
                  <mat-form-field>
                    <mat-label>Straße</mat-label>
                    <input
                      matInput
                      type="text"
                      formControlName="adresse_strasse"
                    />
                    @if (
                      formRechnung.controls.adresse_strasse.hasError("required")
                    ) {
                      <mat-error>Straße ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-2 mb-3">
                  <mat-form-field>
                    <mat-label>PLZ</mat-label>
                    <input matInput type="text" formControlName="adresse_plz" />
                    @if (
                      formRechnung.controls.adresse_plz.hasError("required")
                    ) {
                      <mat-error>PLZ ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>Ort</mat-label>
                    <input matInput type="text" formControlName="adresse_ort" />
                    @if (
                      formRechnung.controls.adresse_ort.hasError("required")
                    ) {
                      <mat-error>Ort ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-8 mb-3">
                  <mat-form-field>
                    <mat-label>Betreff</mat-label>
                    <input matInput type="text" formControlName="betreff" />
                    @if (formRechnung.controls.betreff.hasError("required")) {
                      <mat-error>Betreff ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-4 mb-3">
                  <mat-form-field>
                    <mat-label>Rechnungsnummer</mat-label>
                    <input
                      matInput
                      type="text"
                      formControlName="invoice_nummer"
                    />
                    @if (
                      formRechnung.controls.invoice_nummer.hasError("required")
                    ) {
                      <mat-error>RE Nr. ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-12 mb-3">
                  <mat-form-field>
                    <mat-label>Anrede</mat-label>
                    <input matInput type="text" formControlName="anrede" />
                    @if (formRechnung.controls.anrede.hasError("required")) {
                      <mat-error>Anrede ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-12 mb-3">
                  <mat-form-field>
                    <mat-label>Text</mat-label>
                    <textarea
                      matInput
                      type="text"
                      formControlName="text"
                      rows="4"
                    ></textarea>
                    @if (formRechnung.controls.text.hasError("required")) {
                      <mat-error>Text ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
              </section>
            </form>
            <hr class="mb-3" />
            <h3>Positionen</h3>
            <form
              [formGroup]="formRechnungPositionen"
              (ngSubmit)="addPosition()"
            >
              <section class="app-grid mt-2 mx-0">
                <div class="app-col-12 app-col-lg-6 mb-3">
                  <mat-form-field>
                    <mat-label>Bezeichnung</mat-label>
                    <input matInput type="text" formControlName="bezeichnung" />
                    @if (
                      formRechnungPositionen.controls.bezeichnung.hasError(
                        "required"
                      )
                    ) {
                      <mat-error>Bezeichnung ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-3 mb-3">
                  <mat-form-field>
                    <mat-label>Preis</mat-label>
                    <input matInput type="text" formControlName="preis" />
                    @if (
                      formRechnungPositionen.controls.preis.hasError("required")
                    ) {
                      <mat-error>Preis ist erforderlich!</mat-error>
                    }
                    @if (
                      formRechnungPositionen.controls.preis.hasError("pattern")
                    ) {
                      <mat-error
                        >Ungültiges Format! (z. B. 12,50 oder 12.50)</mat-error
                      >
                    }
                  </mat-form-field>
                </div>
                <div class="app-col-12 app-col-lg-3 mb-3">
                  <button
                    mat-flat-button
                    color="accent"
                    class="m-3"
                    type="submit"
                  >
                    Hinzufügen
                  </button>
                </div>
              </section>
            </form>
            <section>
              <mat-list>
                @for (
                  pos of formRechnung.controls.positionen.value;
                  track $index;
                  let i = $index
                ) {
                  <mat-list-item class="app-grid align-items-center">
                    <div class="app-col-7">{{ pos.bezeichnung }}</div>
                    <div class="app-col-3">{{ formatPreis(pos.preis) }}</div>
                    <div class="app-col-2 text-end">
                      <button
                        mat-icon-button
                        type="button"
                        aria-label="Position löschen"
                        (click)="removePosition(i)"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </mat-list-item>
                }
              </mat-list>
            </section>
          </mat-tab>
          <mat-tab label="Coming Soon" disabled></mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</section>
