<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="pdf-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>Vorlagen verwalten</h2>
    </div>

    <mat-card-content>
      <div class="top-actions">
        <button
          mat-raised-button
          color="accent"
          [hidden]="!formModul.disabled"
          (click)="neueDetails()"
          type="button"
        >
          Hinzufügen
        </button>

        @if (tableVisible) {
          <mat-form-field class="status-filter">
            <mat-label>Status</mat-label>
            <mat-select
              [(ngModel)]="statusFilter"
              [ngModelOptions]="{ standalone: true }"
              (selectionChange)="applyStatusFilter()"
            >
              <mat-option value="ALL">Alle</mat-option>
              <mat-option value="DRAFT">Draft</mat-option>
              <mat-option value="PUBLISHED">Published</mat-option>
              <mat-option value="ARCHIVED">Archived</mat-option>
            </mat-select>
          </mat-form-field>
        }
      </div>

      <form
        [formGroup]="formModul"
        (ngSubmit)="datenSpeichern()"
        [hidden]="formModul.disabled"
        class="edit-form"
      >
        <input hidden type="text" class="form-control" formControlName="id" />
        <input hidden type="text" class="form-control" formControlName="version" />
        <input hidden type="text" class="form-control" formControlName="status" />

        <div class="form-actions">
          <button
            mat-raised-button
            color="accent"
            [hidden]="readonlyMode || !formModul.valid"
            type="submit"
          >
            Daten speichern
          </button>
          <button
            mat-raised-button
            color="primary"
            [hidden]="formModul.disabled"
            type="button"
            (click)="abbrechen()"
          >
            Abbrechen
          </button>
          <button
            mat-raised-button
            color="warn"
            [hidden]="!formModul.controls['id'].value"
            type="button"
            (click)="datenLoeschen()"
          >
            Daten löschen
          </button>
        </div>

        <section class="row form-grid">
          <div class="col-12 col-lg-6 mb-3">
            <mat-form-field hintLabel="* Pflichtfeld" class="full-width">
              <mat-label>Typ / Modul</mat-label>
              <mat-select formControlName="typ">
                @for (opt of typModul; track opt) {
                  <mat-option [value]="opt"> {{ opt }} </mat-option>
                }
              </mat-select>
              @if (formModul.controls['typ'].hasError('required')) {
                <mat-error>Typ ist erforderlich! </mat-error>
              }
            </mat-form-field>
          </div>
          <div class="col-12 col-lg-6 mb-3">
            <mat-form-field hintLabel="* Pflichtfeld" class="full-width">
              <mat-label>Bezeichnung</mat-label>
              <input matInput type="text" formControlName="bezeichnung" />
              @if (formModul.controls['bezeichnung'].hasError('required')) {
                <mat-error>Bezeichnung ist erforderlich! </mat-error>
              }
            </mat-form-field>
          </div>
          <div class="col-12 col-lg-12 mb-3">
            <mat-form-field class="full-width">
              <mat-label>HTML Code</mat-label>
              <textarea matInput formControlName="source" rows="10"></textarea>
            </mat-form-field>
          </div>
        </section>
      </form>

      <div class="table-wrap" [hidden]="!tableVisible">
        <table mat-table [dataSource]="dataSource" matSort>
          <ng-container matColumnDef="typ">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Typ / Modul
            </th>
            <td mat-cell *matCellDef="let element">{{ element.typ }}</td>
          </ng-container>
          <ng-container matColumnDef="version">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Version</th>
            <td mat-cell *matCellDef="let element">{{ element.version }}</td>
          </ng-container>
          <ng-container matColumnDef="bezeichnung">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Bezeichnung
            </th>
            <td mat-cell *matCellDef="let element">
              {{ element.bezeichnung }}
            </td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let element">{{ element.status }}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Aktionen</th>
            <td mat-cell *matCellDef="let element" class="action-cell">
              <button mat-raised-button color="primary" (click)="auswahlBearbeiten(element)">
                <mat-icon class="m-0">edit</mat-icon>
              </button>
              <button mat-raised-button color="primary" (click)="test(element)">
                <mat-icon class="m-0">bug_report</mat-icon>
              </button>
              @if (element.status == 'DRAFT') {
                <button mat-raised-button color="primary" (click)="publish(element)">
                  <mat-icon class="m-0">public</mat-icon>
                </button>
              }
              @if (element.status == 'PUBLISHED') {
                <button mat-raised-button color="primary" (click)="newVersion(element)">
                  <mat-icon class="m-0">upgrade</mat-icon>
                </button>
              }
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="sichtbareSpalten"></tr>
          <tr mat-row *matRowDef="let row; columns: sichtbareSpalten"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</section>
