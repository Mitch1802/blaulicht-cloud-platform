<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="bericht-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>{{ viewMode === 'list' ? 'Einsätze' : 'Einsatz erfassen' }}</h2>
    </div>

    <mat-card-content>
      @if (viewMode === 'list') {
        <section class="drafts-section list-only">
          <div class="actions-row top-actions">
            <button mat-raised-button type="button" color="accent" (click)="neuerEntwurf()">Neuen Einsatz anlegen</button>
          </div>

          <h3>Vorhandene Einsatzberichte</h3>

          @if (berichte.length === 0) {
            <p class="empty">Noch keine Einsatzberichte vorhanden.</p>
          } @else {
            <section class="draft-list">
              @for (element of berichte; track element.id) {
                <article class="draft-item">
                  <div class="draft-main">
                    <strong>{{ element.alarmstichwort || 'Ohne Stichwort' }}</strong>
                    <span>{{ element.einsatzadresse || 'Ohne Adresse' }}</span>
                    <small>{{ element.einsatz_datum || '-' }}</small>
                    <span class="status-badge" [class.done]="element.status === 'ABGESCHLOSSEN'">{{ element.status }}</span>
                  </div>
                  <div class="draft-actions">
                    <button mat-raised-button color="primary" type="button" (click)="berichtBearbeiten(element)">
                      <mat-icon class="m-0">edit</mat-icon>
                    </button>
                    @if (canManageStatus) {
                      <button mat-raised-button type="button" (click)="statusUmschalten(element)">
                        <mat-icon class="m-0">check</mat-icon>
                      </button>
                    }
                    @if (canDeleteBerichte) {
                      <button mat-raised-button color="warn" type="button" (click)="berichtLoeschen(element)">
                        <mat-icon class="m-0">delete</mat-icon>
                      </button>
                    }
                  </div>
                </article>
              }
            </section>
          }
        </section>
      } @else {
      <form [formGroup]="formBericht" (ngSubmit)="speichereBericht()" class="bericht-form">
        <div class="actions-row top-actions">
          <button mat-stroked-button type="button" color="primary" (click)="zurueckZurListe()">Zur Liste</button>
        </div>

        <mat-accordion class="bericht-accordion" [multi]="false">
          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">1. Alarmdaten</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Grunddaten zum Alarm und zur Alarmierung</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid two-col">
            <mat-form-field class="full-width">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                @for (status of statusOptionen; track status.key) {
                  <mat-option [value]="status.key">{{ status.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="prefill-row">
              <button mat-stroked-button type="button" color="accent" (click)="uebernehmeLetztenEinsatz()">
                Daten BlaulichtSMS übernehmen
              </button>
            </div>
          </section>

          <section class="grid two-col">
            <div class="searchable-select">
              <mat-form-field class="full-width">
                <mat-label>Einsatzleiter</mat-label>
                <input
                  matInput
                  [formControl]="einsatzleiterSuche"
                  [matAutocomplete]="einsatzleiterAuto"
                  placeholder="Name oder StbNr"
                />
                <mat-autocomplete #einsatzleiterAuto="matAutocomplete" (optionSelected)="onEinsatzleiterSelected($event)">
                  @for (einsatzleiter of filteredEinsatzleiterOptionen; track einsatzleiter) {
                    <mat-option [value]="einsatzleiter">{{ einsatzleiter }}</mat-option>
                  }
                  @if (filteredEinsatzleiterOptionen.length === 0) {
                    <mat-option disabled>Kein Einsatzleiter gefunden.</mat-option>
                  }
                </mat-autocomplete>
              </mat-form-field>
            </div>

            <mat-form-field class="full-width">
              <mat-label>Einsatzart</mat-label>
              <mat-select formControlName="einsatzart">
                @for (art of einsatzarten; track art) {
                  <mat-option [value]="art">{{ art }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Alarmstichwort</mat-label>
              <input matInput formControlName="alarmstichwort" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Einsatzadresse</mat-label>
              <input matInput formControlName="einsatzadresse" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Alarmierende Stelle</mat-label>
              <mat-select formControlName="alarmierendeStelle">
                @for (stelle of alarmierendeStelleOptionen; track stelle) {
                  <mat-option [value]="stelle">{{ stelle }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </section>

          <section class="grid three-col">
            <mat-form-field class="full-width">
              <mat-label>Einsatz Datum</mat-label>
              <input matInput type="date" formControlName="einsatzDatum" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Ausgerückt</mat-label>
              <input matInput type="time" formControlName="ausgerueckt" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Eingerückt</mat-label>
              <input matInput type="time" formControlName="eingerueckt" />
            </mat-form-field>
          </section>

            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">2. Tätigkeiten</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Verlauf und durchgeführte Maßnahmen</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid one-col">
            <mat-form-field class="full-width">
              <mat-label>Lage beim Eintreffen</mat-label>
              <textarea matInput rows="3" formControlName="lageBeimEintreffen"></textarea>
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Gesetzte Maßnahmen</mat-label>
              <textarea matInput rows="3" formControlName="gesetzteMassnahmen"></textarea>
            </mat-form-field>
          </section>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">3. Einsatzspezifisch</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Brand/Technik und mitalarmierte Stelle</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid two-col">
                <div class="conditional-block">
                  @if (isBrand) {
                    <h3>Brand-Details</h3>
                    <mat-form-field class="full-width">
                      <mat-label>Brand Kategorie</mat-label>
                      <mat-select formControlName="brandKategorie">
                        @for (opt of brandOptionen; track opt) {
                          <mat-option [value]="opt">{{ opt }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                    @if (selectedBrandBeschreibung) {
                      <p class="selection-description">{{ selectedBrandBeschreibung }}</p>
                    }
                  } @else if (isTechnisch) {
                    <h3>Technische-Details</h3>
                    <mat-form-field class="full-width">
                      <mat-label>Technische Kategorie</mat-label>
                      <mat-select formControlName="technischKategorie">
                        @for (opt of technischOptionen; track opt) {
                          <mat-option [value]="opt">{{ opt }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    <h3>Einsatzspezifische Details</h3>
                    <p class="empty">Für diese Einsatzart gibt es keine zusätzlichen Kategorien.</p>
                  }
                </div>

                <div class="conditional-block">
                  <h3>Mitalarmiert</h3>
                  <mat-form-field class="full-width">
                    <mat-label>Mitalarmiert</mat-label>
                    <mat-select formControlName="mitalarmiert">
                      @for (opt of mitalarmiertOptionen; track opt) {
                        <mat-option [value]="opt">{{ opt }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  @if (isMitalarmiertAndere) {
                    <mat-form-field class="full-width">
                      <mat-label>Andere mitalarmierte Stelle</mat-label>
                      <input matInput formControlName="mitalarmiertText" />
                    </mat-form-field>
                  }
                </div>
              </section>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">4. Dokumentation</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Foto-Doku und Nachweise</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
            <section class="conditional-block">
              <h3>Dokumentation & Nachweise</h3>

              <div class="upload-row">
                <label class="upload-label" for="fotoDokuDateien">Foto Doku Dateien</label>
                <input id="fotoDokuDateien" class="file-input-hidden" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" (change)="onDokumentSelected($event, 'fotoDoku')" />
                <label for="fotoDokuDateien" class="upload-button" mat-stroked-button>Dateien auswählen</label>
                @if (fotoDokuFiles.length > 0) {
                  <div class="preview-grid">
                    @for (file of fotoDokuFiles; track file; let i = $index) {
                      <article class="preview-card">
                        @if (file.type.startsWith('image/')) {
                          <img class="preview-image" [src]="getFilePreviewUrl(file)" [alt]="file.name" />
                        } @else {
                          <div class="preview-file">PDF</div>
                        }
                        <div class="preview-meta">
                          <button mat-stroked-button type="button" color="primary" (click)="openFoto(getFilePreviewUrl(file))">Bild öffnen</button>
                          <button mat-stroked-button type="button" color="warn" (click)="removeSelectedDokument(i, 'fotoDoku')">Entfernen</button>
                        </div>
                      </article>
                    }
                  </div>
                }

                @if (bestehendeDokuFotos.length > 0) {
                  <div class="preview-grid existing-previews">
                    @for (foto of bestehendeDokuFotos; track foto.id) {
                      <article class="preview-card">
                        @if (isImagePath(foto.foto_url)) {
                          <img class="preview-image" [src]="foto.foto_url" [alt]="getFileNameFromPath(foto.foto_url)" />
                        } @else {
                          <div class="preview-file">PDF</div>
                        }
                        <div class="preview-meta">
                          <button mat-stroked-button type="button" color="primary" (click)="openFoto(foto.foto_url)">Bild öffnen</button>
                          <button mat-stroked-button type="button" color="warn" (click)="loescheBestehendesFoto(foto)">Löschen</button>
                        </div>
                      </article>
                    }
                  </div>
                }
              </div>

              <div class="upload-row">
                <label class="upload-label" for="zulassungDateien">Zulassungsschein Dateien</label>
                <input id="zulassungDateien" class="file-input-hidden" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" (change)="onDokumentSelected($event, 'zulassungsschein')" />
                <label for="zulassungDateien" class="upload-button" mat-stroked-button>Dateien auswählen</label>
                @if (zulassungFiles.length > 0) {
                  <div class="preview-grid">
                    @for (file of zulassungFiles; track file; let i = $index) {
                      <article class="preview-card">
                        @if (file.type.startsWith('image/')) {
                          <img class="preview-image" [src]="getFilePreviewUrl(file)" [alt]="file.name" />
                        } @else {
                          <div class="preview-file">PDF</div>
                        }
                        <div class="preview-meta">
                          <button mat-stroked-button type="button" color="primary" (click)="openFoto(getFilePreviewUrl(file))">Bild öffnen</button>
                          <button mat-stroked-button type="button" color="warn" (click)="removeSelectedDokument(i, 'zulassungsschein')">Entfernen</button>
                        </div>
                      </article>
                    }
                  </div>
                }

                @if (bestehendeZulassungFotos.length > 0) {
                  <div class="preview-grid existing-previews">
                    @for (foto of bestehendeZulassungFotos; track foto.id) {
                      <article class="preview-card">
                        @if (isImagePath(foto.foto_url)) {
                          <img class="preview-image" [src]="foto.foto_url" [alt]="getFileNameFromPath(foto.foto_url)" />
                        } @else {
                          <div class="preview-file">PDF</div>
                        }
                        <div class="preview-meta">
                          <button mat-stroked-button type="button" color="primary" (click)="openFoto(foto.foto_url)">Bild öffnen</button>
                          <button mat-stroked-button type="button" color="warn" (click)="loescheBestehendesFoto(foto)">Löschen</button>
                        </div>
                      </article>
                    }
                  </div>
                }
              </div>

              <div class="upload-row">
                <label class="upload-label" for="versicherungDateien">Versicherungsschein Dateien</label>
                <input id="versicherungDateien" class="file-input-hidden" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" (change)="onDokumentSelected($event, 'versicherungsschein')" />
                <label for="versicherungDateien" class="upload-button" mat-stroked-button>Dateien auswählen</label>
                @if (versicherungFiles.length > 0) {
                  <div class="preview-grid">
                    @for (file of versicherungFiles; track file; let i = $index) {
                      <article class="preview-card">
                        @if (file.type.startsWith('image/')) {
                          <img class="preview-image" [src]="getFilePreviewUrl(file)" [alt]="file.name" />
                        } @else {
                          <div class="preview-file">PDF</div>
                        }
                        <div class="preview-meta">
                          <button mat-stroked-button type="button" color="primary" (click)="openFoto(getFilePreviewUrl(file))">Bild öffnen</button>
                          <button mat-stroked-button type="button" color="warn" (click)="removeSelectedDokument(i, 'versicherungsschein')">Entfernen</button>
                        </div>
                      </article>
                    }
                  </div>
                }

                @if (bestehendeVersicherungFotos.length > 0) {
                  <div class="preview-grid existing-previews">
                    @for (foto of bestehendeVersicherungFotos; track foto.id) {
                      <article class="preview-card">
                        @if (isImagePath(foto.foto_url)) {
                          <img class="preview-image" [src]="foto.foto_url" [alt]="getFileNameFromPath(foto.foto_url)" />
                        } @else {
                          <div class="preview-file">PDF</div>
                        }
                        <div class="preview-meta">
                          <button mat-stroked-button type="button" color="primary" (click)="openFoto(foto.foto_url)">Bild öffnen</button>
                          <button mat-stroked-button type="button" color="warn" (click)="loescheBestehendesFoto(foto)">Löschen</button>
                        </div>
                      </article>
                    }
                  </div>
                }
              </div>
            </section>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">5. Fahrzeuge &amp; Mitglieder</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Auswahl der eingesetzten Ressourcen</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid two-col">
                <div class="autocomplete-multi">
                  <mat-form-field class="full-width">
                    <mat-label>Fahrzeug hinzufügen</mat-label>
                    <input
                      matInput
                      [formControl]="fahrzeugSuche"
                      [matAutocomplete]="fahrzeugAuto"
                      placeholder="Fahrzeugname"
                    />
                    <mat-autocomplete #fahrzeugAuto="matAutocomplete" (optionSelected)="onFahrzeugSelected($event)">
                      @for (fahrzeug of filteredFahrzeugOptionen; track fahrzeug.id) {
                        <mat-option [value]="fahrzeug.id">{{ fahrzeug.label }}</mat-option>
                      }
                      @if (filteredFahrzeugOptionen.length === 0) {
                        <mat-option disabled>Keine Fahrzeuge gefunden.</mat-option>
                      }
                    </mat-autocomplete>
                  </mat-form-field>

                  <mat-chip-set class="role-chips">
                    @for (fahrzeug of selectedFahrzeugOptionen; track fahrzeug.id) {
                      <mat-chip [removable]="true" (removed)="removeFahrzeug(fahrzeug.id)">
                        {{ fahrzeug.label }}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                    }
                  </mat-chip-set>
                </div>

                <div class="autocomplete-multi">
                  <mat-form-field class="full-width">
                    <mat-label>Mitglied hinzufügen</mat-label>
                    <input
                      matInput
                      [formControl]="mitgliedSuche"
                      [matAutocomplete]="mitgliedAuto"
                      placeholder="Name oder StbNr"
                    />
                    <mat-autocomplete #mitgliedAuto="matAutocomplete" (optionSelected)="onMitgliedSelected($event)">
                      @for (mitglied of filteredMitgliedOptionen; track mitglied.id) {
                        <mat-option [value]="mitglied.id">{{ mitglied.label }}</mat-option>
                      }
                      @if (filteredMitgliedOptionen.length === 0) {
                        <mat-option disabled>Keine Mitglieder gefunden.</mat-option>
                      }
                    </mat-autocomplete>
                  </mat-form-field>

                  <mat-chip-set class="role-chips">
                    @for (mitglied of selectedMitgliedOptionen; track mitglied.id) {
                      <mat-chip [removable]="true" (removed)="removeMitglied(mitglied.id)">
                        {{ mitglied.label }}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                    }
                  </mat-chip-set>
                </div>
              </section>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <div class="form-actions">
          <button mat-raised-button color="accent" type="submit">Einsatzbericht speichern</button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>
</section>