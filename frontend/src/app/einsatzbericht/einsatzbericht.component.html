<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="bericht-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>{{ viewMode === 'list' ? 'Einsätze' : 'Einsatz erfassen' }}</h2>
    </div>

    <mat-card-content>
      @if (viewMode === 'list') {
        <section class="drafts-section list-only">
          <div class="actions-row top-actions">
            <button mat-raised-button type="button" color="accent" (click)="neuerEntwurf()">Neuen Einsatz anlegen</button>
          </div>

          <h3>Vorhandene Einsatzberichte</h3>

          @if (berichte.length === 0) {
            <p class="empty">Noch keine Einsatzberichte vorhanden.</p>
          } @else {
            <div class="draft-list">
              @for (bericht of berichte; track bericht.id) {
                <div class="draft-item">
                  <div class="draft-main">
                    <strong>{{ bericht.alarmstichwort || 'Ohne Stichwort' }}</strong>
                    <span>{{ bericht.einsatzadresse || 'Ohne Adresse' }}</span>
                    <small>{{ bericht.created_at || '' }}</small>
                  </div>

                  <div class="draft-actions">
                    <span class="status-badge" [class.done]="bericht.status === 'ABGESCHLOSSEN'">{{ bericht.status }}</span>
                    <button mat-stroked-button color="primary" type="button" (click)="berichtBearbeiten(bericht)">Öffnen</button>
                    <button mat-stroked-button type="button" (click)="statusUmschalten(bericht)">
                      {{ bericht.status === 'ABGESCHLOSSEN' ? 'Als Entwurf' : 'Abschließen' }}
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </section>
      } @else {
      <form [formGroup]="formBericht" (ngSubmit)="speichereBericht()" class="bericht-form">
        <div class="actions-row top-actions">
          <button mat-stroked-button type="button" color="primary" (click)="zurueckZurListe()">Zur Liste</button>
        </div>

        <mat-accordion class="bericht-accordion" [multi]="false">
          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">1. Alarmdaten</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Grunddaten zum Alarm und zur Alarmierung</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid two-col">
            <mat-form-field class="full-width">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                @for (status of statusOptionen; track status.key) {
                  <mat-option [value]="status.key">{{ status.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="prefill-row">
              <button mat-stroked-button type="button" color="accent" (click)="uebernehmeLetztenEinsatz()">
                Daten BlaulichtSMS übernehmen
              </button>
            </div>
          </section>

          <section class="grid two-col">
            <div class="searchable-select">
              <mat-form-field class="full-width">
                <mat-label>Einsatzleiter (Autocomplete)</mat-label>
                <input
                  matInput
                  [formControl]="einsatzleiterSuche"
                  [matAutocomplete]="einsatzleiterAuto"
                  placeholder="Name oder StbNr"
                />
                <mat-autocomplete #einsatzleiterAuto="matAutocomplete" (optionSelected)="onEinsatzleiterSelected($event)">
                  @for (einsatzleiter of filteredEinsatzleiterOptionen; track einsatzleiter) {
                    <mat-option [value]="einsatzleiter">{{ einsatzleiter }}</mat-option>
                  }
                  @if (filteredEinsatzleiterOptionen.length === 0) {
                    <mat-option disabled>Kein Einsatzleiter gefunden.</mat-option>
                  }
                </mat-autocomplete>
              </mat-form-field>
            </div>

            <mat-form-field class="full-width">
              <mat-label>Einsatzart</mat-label>
              <mat-select formControlName="einsatzart">
                @for (art of einsatzarten; track art) {
                  <mat-option [value]="art">{{ art }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Alarmstichwort</mat-label>
              <input matInput formControlName="alarmstichwort" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Einsatzadresse</mat-label>
              <input matInput formControlName="einsatzadresse" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Alarmierende Stelle</mat-label>
              <input matInput formControlName="alarmierendeStelle" />
            </mat-form-field>
          </section>

          <section class="grid three-col">
            <mat-form-field class="full-width">
              <mat-label>Einsatz Datum</mat-label>
              <input matInput type="date" formControlName="einsatzDatum" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Ausgerückt</mat-label>
              <input matInput type="time" formControlName="ausgerueckt" />
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Eingerückt</mat-label>
              <input matInput type="time" formControlName="eingerueckt" />
            </mat-form-field>
          </section>

          @if (isBrand) {
            <section class="conditional-block">
              <h3>Brand-Details</h3>
              <mat-form-field class="full-width">
                <mat-label>Brand Kategorie</mat-label>
                <mat-select formControlName="brandKategorie">
                  @for (opt of brandOptionen; track opt) {
                    <mat-option [value]="opt">{{ opt }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </section>
          }

          @if (isTechnisch) {
            <section class="conditional-block">
              <h3>Technische-Details</h3>
              <mat-form-field class="full-width">
                <mat-label>Technische Kategorie</mat-label>
                <mat-select formControlName="technischKategorie">
                  @for (opt of technischOptionen; track opt) {
                    <mat-option [value]="opt">{{ opt }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </section>
          }
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">2. Tätigkeiten</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Verlauf und durchgeführte Maßnahmen</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid one-col">
            <mat-form-field class="full-width">
              <mat-label>Lage beim Eintreffen</mat-label>
              <textarea matInput rows="3" formControlName="lageBeimEintreffen"></textarea>
            </mat-form-field>

            <mat-form-field class="full-width">
              <mat-label>Gesetzte Maßnahmen</mat-label>
              <textarea matInput rows="3" formControlName="gesetzteMassnahmen"></textarea>
            </mat-form-field>
          </section>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="form-section">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="form-section-title">3. Ressourcen &amp; Doku</span>
              </mat-panel-title>
              <mat-panel-description>
                <span class="form-section-subtitle">Fahrzeuge, Mitglieder und optionale Dokumentation</span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="form-section-body">
              <section class="grid two-col">
              <div class="autocomplete-multi">
                <mat-form-field class="full-width">
                  <mat-label>Fahrzeug hinzufügen (Autocomplete)</mat-label>
                  <input
                    matInput
                    [formControl]="fahrzeugSuche"
                    [matAutocomplete]="fahrzeugAuto"
                    placeholder="Fahrzeugname"
                  />
                  <mat-autocomplete #fahrzeugAuto="matAutocomplete" (optionSelected)="onFahrzeugSelected($event)">
                    @for (fahrzeug of filteredFahrzeugOptionen; track fahrzeug.id) {
                      <mat-option [value]="fahrzeug.id">{{ fahrzeug.label }}</mat-option>
                    }
                    @if (filteredFahrzeugOptionen.length === 0) {
                      <mat-option disabled>Keine Fahrzeuge gefunden.</mat-option>
                    }
                  </mat-autocomplete>
                </mat-form-field>

                <div class="selected-pills">
                  @for (fahrzeug of selectedFahrzeugOptionen; track fahrzeug.id) {
                    <button type="button" class="pill" (click)="removeFahrzeug(fahrzeug.id)">
                      {{ fahrzeug.label }} <span aria-hidden="true">×</span>
                    </button>
                  }
                </div>
              </div>

              <div class="autocomplete-multi">
                <mat-form-field class="full-width">
                  <mat-label>Mitglied hinzufügen (Autocomplete)</mat-label>
                  <input
                    matInput
                    [formControl]="mitgliedSuche"
                    [matAutocomplete]="mitgliedAuto"
                    placeholder="Name oder StbNr"
                  />
                  <mat-autocomplete #mitgliedAuto="matAutocomplete" (optionSelected)="onMitgliedSelected($event)">
                    @for (mitglied of filteredMitgliedOptionen; track mitglied.id) {
                      <mat-option [value]="mitglied.id">{{ mitglied.label }}</mat-option>
                    }
                    @if (filteredMitgliedOptionen.length === 0) {
                      <mat-option disabled>Keine Mitglieder gefunden.</mat-option>
                    }
                  </mat-autocomplete>
                </mat-form-field>

                <div class="selected-pills">
                  @for (mitglied of selectedMitgliedOptionen; track mitglied.id) {
                    <button type="button" class="pill" (click)="removeMitglied(mitglied.id)">
                      {{ mitglied.label }} <span aria-hidden="true">×</span>
                    </button>
                  }
                </div>
              </div>
            </section>

            <section class="conditional-block">
              <h3>Dokumentation & Nachweise</h3>

              <div class="checkbox-grid">
                <mat-checkbox formControlName="geschaedigterPkw">Geschädigter PKW erfasst</mat-checkbox>
                <mat-checkbox formControlName="fotoDoku">Foto Doku vorhanden</mat-checkbox>
                <mat-checkbox formControlName="zulassungsschein">Zulassungsschein vorhanden</mat-checkbox>
                <mat-checkbox formControlName="versicherungsschein">Versicherungsschein vorhanden</mat-checkbox>
              </div>

              <div class="upload-row">
                <label class="upload-label" for="fotoDokuDateien">Foto Doku Dateien</label>
                <input id="fotoDokuDateien" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" (change)="onDokumentSelected($event, 'fotoDoku')" />
                @if (fotoDokuDateien.length > 0) {
                  <ul class="file-list">
                    @for (file of fotoDokuDateien; track file) {
                      <li>{{ file }}</li>
                    }
                  </ul>
                }
              </div>

              <div class="upload-row">
                <label class="upload-label" for="zulassungDateien">Zulassungsschein Dateien</label>
                <input id="zulassungDateien" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" (change)="onDokumentSelected($event, 'zulassungsschein')" />
                @if (zulassungDateien.length > 0) {
                  <ul class="file-list">
                    @for (file of zulassungDateien; track file) {
                      <li>{{ file }}</li>
                    }
                  </ul>
                }
              </div>

              <div class="upload-row">
                <label class="upload-label" for="versicherungDateien">Versicherungsschein Dateien</label>
                <input id="versicherungDateien" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" (change)="onDokumentSelected($event, 'versicherungsschein')" />
                @if (versicherungDateien.length > 0) {
                  <ul class="file-list">
                    @for (file of versicherungDateien; track file) {
                      <li>{{ file }}</li>
                    }
                  </ul>
                }
              </div>

              @if (bestehendeDateien.length > 0) {
                <div class="upload-row">
                  <label class="upload-label">Bereits hochgeladene Dateien</label>
                  <ul class="file-list">
                    @for (file of bestehendeDateien; track file) {
                      <li>{{ file }}</li>
                    }
                  </ul>
                </div>
              }
            </section>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <div class="actions-row">
          <button mat-raised-button color="accent" type="submit">Einsatzbericht speichern</button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>
</section>