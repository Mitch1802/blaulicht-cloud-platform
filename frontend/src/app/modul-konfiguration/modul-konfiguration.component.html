<app-header [breadcrumb]="breadcrumb"></app-header>

<section class="modul-page">
  <header class="page-head">
    <h1>{{ title }}</h1>
  </header>

  <mat-card class="settings-card">
    <div class="section-head">
      <h2>Modul-Einstellungen</h2>
    </div>

    <mat-card-content>
      <form [formGroup]="formModul" (ngSubmit)="datenSpeichern()" class="modul-form">
        <input hidden type="text" class="form-control" formControlName="id" />

        <div class="form-actions">
          <button
            mat-flat-button
            color="accent"
            [hidden]="!formModul.valid"
            type="submit"
          >
            Daten speichern
          </button>
          <button
            mat-flat-button
            color="warn"
            [hidden]="!formModul.controls['id'].value"
            type="button"
            (click)="datenLoeschen()"
          >
            Daten löschen
          </button>
        </div>

        <section class="app-grid form-grid">
          <div class="app-col-12 app-col-lg-12 mb-3">
            <mat-form-field class="full-width">
              <mat-label>Verfügbare Module auswählen</mat-label>
              <mat-select formControlName="modul" (selectionChange)="onModulChange()">
                <mat-option [value]="''">Bitte auswählen</mat-option>
                @for (m of verfuegbareModulListe; track m.key) {
                  <mat-option [value]="m.key">{{ m.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="app-col-12 app-col-lg-12 mb-3">
            @if (formModul.controls['modul'].value === 'pdf') {
              <div [formGroup]="pdfMappingForm" class="pdf-mapping">
                @for (ex of pdfExports; track ex.key) {
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ ex.label }}</mat-label>
                    <mat-select [formControlName]="ex.key">
                      <mat-option [value]="null">Bitte auswählen</mat-option>
                      @for (t of pdfTemplates; track t.id) {
                        <mat-option [value]="t.id">
                          {{ t.typ }} v{{ t.version }} – {{ t.bezeichnung }}
                        </mat-option>
                      }
                    </mat-select>

                    @if (pdfMappingForm.controls[ex.key].hasError('required')) {
                      <mat-error>Template ist erforderlich!</mat-error>
                    }
                  </mat-form-field>
                }
              </div>

              <textarea hidden matInput formControlName="konfiguration"></textarea>
            } @else {
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Konfiguration (JSON)</mat-label>
                <textarea
                  matInput
                  formControlName="konfiguration"
                  rows="12"
                  placeholder="{ 'key': 'value' }"
                ></textarea>

                @if (formModul.controls['konfiguration'].hasError('required')) {
                  <mat-error>Konfiguration ist erforderlich!</mat-error>
                }
                @if (formModul.controls['konfiguration'].hasError('jsonInvalid')) {
                  <mat-error>Ungültiges JSON!</mat-error>
                }
              </mat-form-field>
            }
          </div>
        </section>
      </form>
    </mat-card-content>
  </mat-card>
</section>
